#!/usr/bin/perl -w

# $Id: JHdiary 1.23 1997/10/07 11:43:07 jh48501 Exp $
# $Source: /Users/johayek/git-servers/github.com/JochenHayek/misc/diary/RCS/JHdiary $
# Time-stamp: <97/10/07 12:37:19 jh48501>

# Usage: 

# in:

# out:

# requirements:

{
  $debug   = 1;
  # $p_do_it = 1;
  $p_echo_the_source = 1;

  die "I need at least the company tag." if $#ARGV < 0;

  local($company_tag) = shift;

  if (0)
    {
      # described in:
      #		camel book / ch. 7: the std. perl lib. / lib. modules / Getopt::Long - ...

      use Getopt::Long;
      %options = ();

      {
	# defaults for the main::options;
	
	$main::options{dry_run}		       = 0;
	$main::options{version}		       = 0;

	$main::options{compain_about_manual_computing} = 0;

	$main::options{job_xxx}                    = 1;
      }

      local($result) =
	&GetOptions
	  (\%options
	   ,'columns=i'			# 1..3
	   ,'landscape','portrait'	# 
	   ,'font_size=i'		# 6,12,24
	   ,'no_header'			# pr(1)'s `-t'
	   ,'offset=i'			# pr(1)'s `-o'
	   );

      $result || die 'GetOptions failed';
    }

  %month_name2no =
    ( 'Jan', 1,'Feb', 2,'Mar', 3
     ,'Apr', 4,'May', 5,'Jun', 6
     ,'Jul', 7,'Aug', 8,'Sep', 9
     ,'Oct',10,'Nov',11,'Dec',12
     );

  local($total_work::min) = 0;

  open(TBL,">$ENV{'HOME'}/diary.month-tbl") || die "cannot open month tbl: $! -";

  my($total_min_today) = 0;
  my( $work_min_today) = 0;
  my($day_separator) = '';

  while (<>)
    {
      chop;

      local($other_tags);

      if (m/^(\d\d) (\w\w\w) (\d\d\d\d)/)
	{
	  $this_day     = $_;
	  $day_of_month = $1;
	  $month        = $month_name2no{$2};
	  $year         = $3;

	  if (0 && $debug)
	    {
	      printf STDERR "=%d: %s=>'%s',%s=>%d\n",__LINE__
		,'$this_day',$this_day
		,'$day_of_month',$day_of_month
		;
	    }

	  print $_,"\n" if $p_echo_the_source;

	  $total_min_today = 0;
	  $work_min_today  = 0;
	  print TBL $day_separator;
	  $day_separator = "_\n";
	}

      elsif (m/^\t(\d\d):(\d\d) \.\. (\d\d):(\d\d)=(\w\w):(\w\w)=(\w\w):(\w\w)\+(\d\d):(\d\d)--S:\w\w\w:\w\w\((\w\w\w)\) \[work\@$company_tag((,)(.+))?\]$/)
	{
	  local($start_hh,$start_mm) = ( $1, $2); local($start_min) = $start_hh * 60 + $start_mm;
	  local($end_hh  ,$end_mm  ) = ( $3, $4); local($end_min  ) = $end_hh   * 60 + $end_mm;
	  local($total_hh,$total_mm) = ( $5, $6);
	  local($work_hh ,$work_mm ) = ( $7, $8);
	  local($break_hh,$break_mm) = ( $9,$10);
	  local($target_hhh        ) = ($11    );
	  local($other_tags_dummy,$other_tags_separator,$other_tags) = ($12,$13,$14);
	  local($other_tags_alt_separator);

	  if(defined($other_tags_dummy))
	    {
	      $other_tags_alt_separator = '|';
	      $other_tags           	=~ s/,/|/g;
	    }
	  else
	    {
	      $other_tags_dummy         = '';
	      $other_tags_alt_separator = '';
	      $other_tags_separator 	= '';
	      $other_tags           	= '';
	    }

	  local($total_min__computed) = $end_min - $start_min;

	  if ("$total_hh:$total_mm" eq 'hh:mm') # concerns `total' time
	    {
	    }
	  else
	    {
	      local($total_min) = $total_hh * 60 + $total_mm;

	      if(   $main::options{compain_about_manual_computing}
		 && ($total_min__computed != $total_min)
		 )
		{
		  printf STDERR "=%d: %s=>%d,%s=>%d,%s=>%d\n",__LINE__
		    ,'$.',$.
		    ,'$total_min__computed',$total_min__computed
		    ,'$total_min'          ,$total_min
		    ;
		  warn "manual computing is not that easy ... - sum";
		}
	    }

	  local($total_min) = $total_min__computed;
	  $total_min_today += $total_min;

	  local($break_min)  = $break_hh  * 60 + $break_mm;

	  local($work_min__computed) = $total_min__computed - $break_min;

	  if ("$work_hh:$work_mm" eq 'hh:mm') # concerns `work' time
	    {
	    }
	  else
	    {
	      local($work_min)   = $work_hh   * 60 + $work_mm ;

	      if  (   (($work_min+$break_min) != $total_min)
		   && $main::options{compain_about_manual_computing}
		   )
		{
		  printf STDERR "=%d: %s=>%d,%s=>%d,%s=>%d,%s=>%d\n",__LINE__
		    ,'$.',$.
		    ,'$work_min' ,$work_min
		    ,'$break_min',$break_min
		    ,'$total_min',$total_min
		    ;
		  warn "manual computing is not that easy ... - sum-break";
		}
	    }

	  local($work_min) = $work_min__computed;

	  $work_min_today  += $work_min;

	  $total_work::min += $work_min;

	  printf STDERR
	    ( "%04.4d-%02.2d-%02.2d"
	     ."|%02.2d:%02.2d|%02.2d:%02.2d"
	     ."|%s|%s"		# total
	     ."|%s|%s|%4.4d"	# worked
	     ."|%s%s%s\n"
	     )

	    ,$year,$month,$day_of_month

	    ,$start_hh,$start_mm,$end_hh ,$end_mm

	    ,&min_2_hh_mm($total_min)
	    ,&min_2_hh_mm($total_min_today)

	    ,&min_2_hh_mm($work_min)
	    ,&min_2_hh_mm($work_min_today)
	    ,$work_min

	    ,$this_day
	    ,$other_tags_alt_separator
	    ,$other_tags
	    ;

	  printf TBL
	    ( "%04.4d-%02.2d-%02.2d"
	     ."|%02.2d:%02.2d|%02.2d:%02.2d"
	     ."|%s|%s"
	     ."|%s|%s|%4.4d"
	     ."%s%s\n"
	     )

	    ,$year,$month,$day_of_month

	    ,$start_hh,$start_mm,$end_hh ,$end_mm

	    ,&min_2_hh_mm($total_min)
	    ,&min_2_hh_mm($total_min_today)

	    ,&min_2_hh_mm($work_min)
	    ,&min_2_hh_mm($work_min_today)
	    ,$work_min

	    ,$other_tags_alt_separator
	    ,$other_tags
	    ;

	  printf
	    "\t%02.2d:%02.2d .. %02.2d:%02.2d=%s=%s+%02.2d:%02.2d--S:%s(%s) [%s%s]\n"
	    ,$start_hh,$start_mm,$end_hh ,$end_mm
	    ,&min_2_hh_mm($total_min)
	    ,&min_2_hh_mm($work_min)
	    ,$break_hh,$break_mm
	    ,&min_2_hhh_mm($total_work::min)
	    ,$target_hhh
	    ,"work\@${company_tag}"
	    ,$other_tags_dummy
	    if $p_echo_the_source;
	}

      elsif (m/^\t\w\w:\w\w \.\. \w\w:\w\w=(\w\w):(\w\w)=(\w\w):(\w\w)\+\d\d:\d\d--S:\w\w\w:\m\m\(\w\w\w\) \[work\@$company_tag(,.+)?\]$/)
	{
	  print $_,"\n" if $p_echo_the_source;
	}

      elsif (m/work\@$company_tag/)
	{
	  printf STDERR "=%d: %s=>%d,%s=>'%s' // %s\n",__LINE__
	    ,'$.',$.
	    ,'$_',$_
	    ,"mysteriously matching [work\@${company_tag}]"
	    ;
	  print $_,"\n" if $p_echo_the_source;
	}
      else
	{
	  print $_,"\n" if $p_echo_the_source;
	}
    }

  if (1)
    {
      printf STDERR "=%d: %s=>%04.4d,%s=>%s\n",__LINE__
	,'$total_work::min',$total_work::min
	,'$total_work::{hh,mm}' ,&min_2_hhh_mm($total_work::min)
	;
      printf TBL
	"=\n|||||%s|%s|%4.4d\n"
	,&min_2_hh_mm($total_work::min)
	,&min_2_hh_mm($total_work::min)
	,$total_work::min
	;
      printf TBL ".\\\" =%d: %s=>%04.4d,%s=>%s // %s\n",__LINE__
	,'$total_work::min',$total_work::min
	,'$total_work::{hh,mm}',&min_2_hhh_mm($total_work::min)
	,&min_2_hhh_mm($total_work::min)
	if 0;
    }

  close(TBL);
}
#
sub min_2_hhh_mm
{
  my($package,$filename,$line,$proc_name) = caller(0);

  #my(%param) = @_;
  my($min) = @_;

  $return_value = 0;

  printf STDERR ">%s,%d,%s\n",__FILE__,__LINE__,$proc_name
    if 0 && $main::options{debug};
  printf STDERR "=%s,%d,%s: %s=>{%s}\n",__FILE__,__LINE__,$proc_name
    ,'$file_name',$file_name
      if 0 && $main::options{debug};

  &discard_unused_variables($file_name) if 0;

  my($mm) =  $min        % 60;
  my($hh) = ($min - $mm) / 60;

  $return_value = sprintf "%03.3d:%02.2d",$hh,$mm;

  printf STDERR "<%s,%d,%s: %s=>%d\n",__FILE__,__LINE__,$proc_name
    ,'$return_value',$return_value
    if 0 && $main::options{debug};

  return $return_value;
}
#
sub min_2_hh_mm
{
  my($package,$filename,$line,$proc_name) = caller(0);

  #my(%param) = @_;
  my($min) = @_;

  $return_value = 0;

  printf STDERR ">%s,%d,%s\n",__FILE__,__LINE__,$proc_name
    if 0 && $main::options{debug};
  printf STDERR "=%s,%d,%s: %s=>{%s}\n",__FILE__,__LINE__,$proc_name
    ,'$file_name',$file_name
      if 0 && $main::options{debug};

  &discard_unused_variables($file_name) if 0;

  my($mm) =  $min        % 60;
  my($hh) = ($min - $mm) / 60;

  $return_value = sprintf "%02.2d:%02.2d",$hh,$mm;

  printf STDERR "<%s,%d,%s: %s=>%d\n",__FILE__,__LINE__,$proc_name
    ,'$return_value',$return_value
    if 0 && $main::options{debug};

  return $return_value;
}
#
sub aux_
{
  my($package,$filename,$line,$proc_name) = caller(0);

  my(%param) = @_;

  $return_value = 0;

  printf STDERR ">%s,%d,%s\n",__FILE__,__LINE__,$proc_name
    if 0 && $main::options{debug};
  printf STDERR "=%s,%d,%s: %s=>{%s}\n",__FILE__,__LINE__,$proc_name
    ,'$file_name',$file_name
      if 0 && $main::options{debug};

  &discard_unused_variables($file_name) if 0;

  printf STDERR "<%s,%d,%s: %s=>%d\n",__FILE__,__LINE__,$proc_name
    ,'$return_value',$return_value
    if 0 && $main::options{debug};

  return $return_value;
}
